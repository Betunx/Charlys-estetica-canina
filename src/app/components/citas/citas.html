<section class="citas">
  <div class="container">
    <div class="section-header">
      <h1>Agendar Cita</h1>
      <p>Selecciona el d√≠a y hora que mejor te convenga</p>
    </div>

    <div class="citas-grid">
      <!-- Calendario -->
      <div class="calendario-container">
        <div class="calendario-header">
          <button class="btn-mes" (click)="mesAnterior()">
            <span>‚Üê</span>
          </button>
          <h2 class="mes-nombre">{{ nombreMes() }}</h2>
          <button class="btn-mes" (click)="mesSiguiente()">
            <span>‚Üí</span>
          </button>
        </div>

        <div class="calendario-dias-semana">
          <div class="dia-semana">Dom</div>
          <div class="dia-semana">Lun</div>
          <div class="dia-semana">Mar</div>
          <div class="dia-semana">Mi√©</div>
          <div class="dia-semana">Jue</div>
          <div class="dia-semana">Vie</div>
          <div class="dia-semana">S√°b</div>
        </div>

        <div class="calendario-grid">
          @for (dia of diasCalendario(); track dia.numero) {
            <div
              [class]="obtenerClaseDia(dia)"
              (click)="seleccionarDia(dia)"
            >
              @if (dia.numero > 0) {
                <span class="dia-numero">{{ dia.numero }}</span>
                @if (dia.disponibilidad === 'disponible') {
                  <span class="dia-estado">‚úì</span>
                }
                @if (dia.disponibilidad === 'medio') {
                  <span class="dia-estado">~</span>
                }
                @if (dia.disponibilidad === 'lleno') {
                  <span class="dia-estado">‚úï</span>
                }
              }
            </div>
          }
        </div>

        <div class="leyenda">
          <div class="leyenda-item">
            <div class="leyenda-color dia-disponible"></div>
            <span>Disponible</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color dia-medio"></div>
            <span>Medio lleno</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color dia-lleno"></div>
            <span>Lleno</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color dia-cerrado"></div>
            <span>Cerrado</span>
          </div>
        </div>
      </div>

      <!-- Selecci√≥n de hora y confirmaci√≥n -->
      <div class="seleccion-container">
        @if (diaSeleccionado()) {
          <div class="hora-seleccion">
            <h3>Selecciona una hora</h3>
            <p class="fecha-seleccionada">
              {{ diaSeleccionado()!.fecha.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              }) }}
            </p>

            <!-- Mensaje de carga -->
            @if (cargando()) {
              <div class="loading">
                <div class="spinner"></div>
                <p>Cargando horarios disponibles...</p>
              </div>
            }

            <!-- Horarios disponibles -->
            @if (!cargando() && getHorasDisponibles().length > 0) {
              <div class="horas-grid">
                @for (hora of getHorasDisponibles(); track hora) {
                  <button
                    class="hora-btn"
                    [class.hora-seleccionada]="horaSeleccionada() === hora"
                    (click)="seleccionarHora(hora)"
                  >
                    {{ hora }}
                  </button>
                }
              </div>
            }

            <!-- Sin horarios disponibles -->
            @if (!cargando() && getHorasDisponibles().length === 0) {
              <div class="sin-horarios">
                <p>‚ö†Ô∏è No hay horarios disponibles para este d√≠a</p>
                <p class="texto-pequeno">Por favor selecciona otro d√≠a</p>
              </div>
            }

            <!-- Formulario de cita -->
            @if (horaSeleccionada() && mostrarFormulario()) {
              <div class="formulario-cita">
                <h4>Completa tus datos</h4>

                <!-- Mensajes -->
                @if (mensajeExito()) {
                  <div class="mensaje-exito">
                    ‚úì {{ mensajeExito() }}
                  </div>
                }

                @if (mensajeError()) {
                  <div class="mensaje-error">
                    ‚ö† {{ mensajeError() }}
                  </div>
                }

                <form (ngSubmit)="agendarCita()" #citaForm="ngForm">
                  <div class="form-group">
                    <label for="nombreCliente">Tu nombre *</label>
                    <input
                      type="text"
                      id="nombreCliente"
                      name="nombreCliente"
                      [(ngModel)]="formularioCita.nombreCliente"
                      required
                      minlength="3"
                      placeholder="Ej: Juan P√©rez"
                      [disabled]="cargando()"
                    >
                  </div>

                  <div class="form-group">
                    <label for="telefono">Tel√©fono *</label>
                    <input
                      type="tel"
                      id="telefono"
                      name="telefono"
                      [(ngModel)]="formularioCita.telefono"
                      required
                      pattern="[0-9]{10}"
                      placeholder="Ej: 6621949884"
                      [disabled]="cargando()"
                    >
                  </div>

                  <div class="form-group">
                    <label for="emailCliente">Email (opcional)</label>
                    <input
                      type="email"
                      id="emailCliente"
                      name="emailCliente"
                      [(ngModel)]="formularioCita.emailCliente"
                      placeholder="Ej: tu@email.com"
                      [disabled]="cargando()"
                    >
                  </div>

                  <div class="form-group">
                    <label for="nombreMascota">Nombre de tu mascota *</label>
                    <input
                      type="text"
                      id="nombreMascota"
                      name="nombreMascota"
                      [(ngModel)]="formularioCita.nombreMascota"
                      required
                      minlength="2"
                      placeholder="Ej: Max"
                      [disabled]="cargando()"
                    >
                  </div>

                  <div class="form-group">
                    <label for="servicio">Servicio *</label>
                    <select
                      id="servicio"
                      name="servicio"
                      [(ngModel)]="formularioCita.servicio"
                      required
                      [disabled]="cargando()"
                    >
                      <option value="">Selecciona un servicio</option>
                      @for (servicio of serviciosDisponibles; track servicio) {
                        <option [value]="servicio">{{ servicio }}</option>
                      }
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="notas">Notas adicionales (opcional)</label>
                    <textarea
                      id="notas"
                      name="notas"
                      [(ngModel)]="formularioCita.notas"
                      rows="3"
                      placeholder="Ej: Mi perro es nervioso con las tijeras"
                      [disabled]="cargando()"
                    ></textarea>
                  </div>

                  <div class="resumen-seleccion">
                    <h5>Resumen de tu cita:</h5>
                    <p><strong>üìÖ Fecha:</strong> {{ diaSeleccionado()!.fecha.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) }}</p>
                    <p><strong>üïê Hora:</strong> {{ horaSeleccionada() }}</p>
                  </div>

                  <button
                    type="submit"
                    class="btn-primary btn-agendar"
                    [disabled]="!citaForm.form.valid || cargando()"
                  >
                    @if (cargando()) {
                      <span>Agendando...</span>
                    } @else {
                      <span>Confirmar Cita</span>
                    }
                  </button>
                </form>
              </div>
            }
          </div>
        } @else {
          <div class="placeholder-seleccion">
            <div class="placeholder-icon">üìÖ</div>
            <h3>Selecciona un d√≠a disponible</h3>
            <p>Elige una fecha del calendario para ver los horarios disponibles</p>
          </div>
        }
      </div>
    </div>
  </div>
</section>
